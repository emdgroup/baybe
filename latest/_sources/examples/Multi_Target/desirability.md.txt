# Example for using the multi target mode for the objective

Example for using the multi target mode for the objective.
It uses a desirability value to handle several targets.

This example assumes some basic familiarity with using BayBE.
We thus refer to [`campaign`](./../Basics/campaign.md) for a basic example.

## Necessary imports for this example


```python
import pandas as pd
```


```python
from baybe import Campaign
from baybe.objectives import DesirabilityObjective
from baybe.parameters import CategoricalParameter, NumericalDiscreteParameter
from baybe.searchspace import SearchSpace
from baybe.targets import NumericalTarget
from baybe.utils.dataframe import add_fake_measurements
```

## Experiment setup and creating the searchspace


```python
Categorical_1 = CategoricalParameter("Cat_1", values=["22", "33"], encoding="OHE")
Categorical_2 = CategoricalParameter(
    "Cat_2",
    values=["very bad", "bad", "OK", "good", "very good"],
    encoding="INT",
)
Num_disc_1 = NumericalDiscreteParameter(
    "Num_disc_1", values=[1, 2, 3, 4, 6, 8, 10], tolerance=0.3
)
Num_disc_2 = NumericalDiscreteParameter(
    "Num_disc_2", values=[-1, -3, -6, -9], tolerance=0.3
)
```


```python
parameters = [Categorical_1, Categorical_2, Num_disc_1, Num_disc_2]
```


```python
searchspace = SearchSpace.from_product(parameters=parameters)
```

## Defining the targets

The multi target mode is handled when creating the objective object.
Thus we first need to define the different targets.

This examples has different targets with different modes.
The first target is maximized and while the second one is minimized.
Note that in this multi target mode, the user must specify bounds for each target.


```python
Target_1 = NumericalTarget(
    name="Target_1", mode="MAX", bounds=(0, 100), transformation="LINEAR"
)
Target_2 = NumericalTarget(
    name="Target_2", mode="MIN", bounds=(0, 100), transformation="LINEAR"
)
```

For each target it is also possible to specify a `target_transform` function.
A detailed discussion of this functionality can be found at the end of this example.

In this example, define a third target working with the mode `MATCH`.
We furthermore use `target_transform="BELL"`.


```python
Target_3 = NumericalTarget(
    name="Target_3", mode="MATCH", bounds=(45, 55), transformation="BELL"
)
```

Note that the `MATCH` mode seeks to have the target at the mean between the two bounds.
For example, choosing 95 and 105 will lead the algorithm seeking 100 as the optimal
value.
Thus, using the bounds, it is possible to control both the match target and
the range around this target that is considered viable.

## Creating the objective

Now to work with these three targets the objective object must be properly created.
The mode is set to `DESIRABILITY` and the targets are described in a list.


```python
targets = [Target_1, Target_2, Target_3]
```

As the recommender requires a single function, the different targets need to be
combined.
Thus, a `scalarizer` is used to create a single target out of the several targets given.
The combine function can either be the mean `MEAN` or the geometric mean `GEOM_MEAN`.
Per default, `GEOM_MEAN` is used.
Weights for each target can also be specified as a list of floats in the arguments
Per default, weights are equally distributed between all targets and are normalized
internally.
It is thus not necessary to handle normalization or scaling.


```python
objective = DesirabilityObjective(
    targets=targets,
    weights=[20, 20, 60],
    scalarizer="MEAN",
)
```


```python
print(objective)
```

    Objective
       Type: DesirabilityObjective
       Targets
                        Type      Name  ... Transformation  Weight
          0  NumericalTarget  Target_1  ...         LINEAR    20.0
          1  NumericalTarget  Target_2  ...         LINEAR    20.0
          2  NumericalTarget  Target_3  ...           BELL    60.0
          
          [3 rows x 7 columns]
       Scalarizer: MEAN


## Creating and printing the campaign


```python
campaign = Campaign(searchspace=searchspace, objective=objective)
print(campaign)
```

    Campaign
       Meta Data
          Batches done: 0
          Fits done: 0
          Discrete Subspace Meta Data
             Recommended: 0/280
             Measured: 0/280
             Excluded: 0/280
       SearchSpace
          Search Space Type: DISCRETE
          SubspaceDiscrete
             Discrete Parameters
                         Name                        Type  ...                 Encoding
nActiveValues
                0       Cat_1        CategoricalParameter  ...  CategoricalEncoding.OHE
2.0
                1       Cat_2        CategoricalParameter  ...  CategoricalEncoding.INT
5.0
                2  Num_disc_1  NumericalDiscreteParameter  ...                     None
NaN
                3  Num_disc_2  NumericalDiscreteParameter  ...                     None
NaN
                
                [4 rows x 5 columns]
             Experimental Representation
                    Cat_1      Cat_2  Num_disc_1  Num_disc_2
                0      22         OK         1.0        -9.0
                1      22         OK         1.0        -6.0
                2      22         OK         1.0        -3.0
                ..    ...        ...         ...         ...
                277    33  very good        10.0        -6.0
                278    33  very good        10.0        -3.0
                279    33  very good        10.0        -1.0
                
                [280 rows x 4 columns]
             Constraints
                Empty DataFrame
                Columns: []
                Index: []
             Computational Representation
                     Cat_1_22  Cat_1_33  ...  Num_disc_1  Num_disc_2
                0         1.0       0.0  ...         1.0        -9.0
                1         1.0       0.0  ...         1.0        -6.0
                2         1.0       0.0  ...         1.0        -3.0
                ..        ...       ...  ...         ...         ...
                277       0.0       1.0  ...        10.0        -6.0
                278       0.0       1.0  ...        10.0        -3.0
                279       0.0       1.0  ...        10.0        -1.0
                
                [280 rows x 5 columns]
       Objective
          Type: DesirabilityObjective
          Targets
                           Type      Name  ... Transformation  Weight
             0  NumericalTarget  Target_1  ...         LINEAR    20.0
             1  NumericalTarget  Target_2  ...         LINEAR    20.0
             2  NumericalTarget  Target_3  ...           BELL    60.0
             
             [3 rows x 7 columns]
          Scalarizer: MEAN
       TwoPhaseMetaRecommender
          Initial recommender
             RandomRecommender
                Compatibility: SearchSpaceType.HYBRID
          Recommender
             BotorchRecommender
                Surrogate
                   GaussianProcessSurrogate
                      Supports Transfer Learning: True
                      Kernel factory: DefaultKernelFactory()
                Acquisition function: None
                Compatibility: SearchSpaceType.HYBRID
                Sequential continuous: True
                Hybrid sampler: None
                Sampling percentage: 1.0
          Switch after: 1
          Remain switched: False
          Has switched: False


## Performing some iterations

The following loop performs some recommendations and adds fake results.
It also prints what happens to internal data.


```python
N_ITERATIONS = 3
```


```python
for kIter in range(N_ITERATIONS):
    rec = campaign.recommend(batch_size=3)
    add_fake_measurements(rec, campaign.targets)
    campaign.add_measurements(rec)
    desirability = campaign.objective.transform(campaign.measurements, allow_extra=True)

    print(f"\n\n#### ITERATION {kIter + 1} ####")
    print("\nRecommended measurements with fake measured results:\n")
    print(rec)
    print("\nInternal measurement database with desirability values:\n")
    print(pd.concat([campaign.measurements, desirability], axis=1))
```

    
    
    #### ITERATION 1 ####
    
    Recommended measurements with fake measured results:
    
        Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2   Target_3
    259    33  very good         2.0        -1.0  37.938227  88.870811  55.325603
    269    33  very good         6.0        -6.0  41.325868  26.425240  53.426331
    109    22   very bad        10.0        -6.0   2.024172  88.164946  53.929711
    
    Internal measurement database with desirability values:
    
      Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2   Target_3  \
    0    33  very good         2.0        -1.0  37.938227  88.870811  55.325603   
    1    33  very good         6.0        -6.0  41.325868  26.425240  53.426331   
    2    22   very bad        10.0        -6.0   2.024172  88.164946  53.929711   
    
       BatchNr  FitNr  Desirability  
    0        1    NaN      0.438388  
    1        1    NaN      0.704241  
    2        1    NaN      0.468292  


    
    
    #### ITERATION 2 ####
    
    Recommended measurements with fake measured results:
    
          Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2  \
    index                                                                  
    273      33  very good         8.0        -6.0  20.732687  58.971786   
    265      33  very good         4.0        -6.0  96.251343  91.024724   
    241      33   very bad         6.0        -6.0  34.708308  16.447326   
    
            Target_3  
    index             
    273    53.313044  
    265    54.310628  
    241    55.153755  
    
    Internal measurement database with desirability values:
    
      Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2   Target_3  \
    0    33  very good         2.0        -1.0  37.938227  88.870811  55.325603   
    1    33  very good         6.0        -6.0  41.325868  26.425240  53.426331   
    2    22   very bad        10.0        -6.0   2.024172  88.164946  53.929711   
    3    33  very good         8.0        -6.0  20.732687  58.971786  53.313044   
    4    33  very good         4.0        -6.0  96.251343  91.024724  54.310628   
    5    33   very bad         6.0        -6.0  34.708308  16.447326  55.153755   
    
       BatchNr  FitNr  Desirability  
    0        1    1.0      0.438388  
    1        1    1.0      0.704241  
    2        1    1.0      0.468292  
    3        2    NaN      0.605262  
    4        2    NaN      0.624219  
    5        2    NaN      0.589253  
    
    
    #### ITERATION 3 ####
    
    Recommended measurements with fake measured results:
    
          Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2  \
    index                                                                  
    268      33  very good         6.0        -9.0  44.382585  97.072536   
    274      33  very good         8.0        -3.0  35.390587  92.281748   
    3        22         OK         1.0        -1.0  28.537620  32.363513   
    
            Target_3  
    index             
    268    54.118507  
    274    55.504539  
    3      53.203014  
    
    Internal measurement database with desirability values:
    
      Cat_1      Cat_2  Num_disc_1  Num_disc_2   Target_1   Target_2   Target_3  \
    0    33  very good         2.0        -1.0  37.938227  88.870811  55.325603   
    1    33  very good         6.0        -6.0  41.325868  26.425240  53.426331   
    2    22   very bad        10.0        -6.0   2.024172  88.164946  53.929711   
    3    33  very good         8.0        -6.0  20.732687  58.971786  53.313044   
    4    33  very good         4.0        -6.0  96.251343  91.024724  54.310628   
    5    33   very bad         6.0        -6.0  34.708308  16.447326  55.153755   
    6    33  very good         6.0        -9.0  44.382585  97.072536  54.118507   
    7    33  very good         8.0        -3.0  35.390587  92.281748  55.504539   
    8    22         OK         1.0        -1.0  28.537620  32.363513  53.203014   
    
       BatchNr  FitNr  Desirability  
    0        1    1.0      0.438388  
    1        1    1.0      0.704241  
    2        1    1.0      0.468292  
    3        2    2.0      0.605262  
    4        2    2.0      0.624219  
    5        2    2.0      0.589253  
    6        3    NaN      0.522006  
    7        3    NaN      0.413535  
    8        3    NaN      0.681046  


## Addendum: Description of `transformation` functions

This function is used to transform target values to the interval `[0,1]` for `MAX`/`MIN`
mode.
An ascending or decreasing `LINEAR` function is used per default.
This function maps input values in a specified interval [lower, upper] to the interval
`[0,1]`.
Outside the specified interval, the function remains constant, that is, 0 or 1.

For the match mode, two functions are available `TRIANGULAR` and `BELL`.
The `TRIANGULAR` function is 0 outside a specified interval and linearly increases to 1
from both
interval ends, reaching the value 1 at the center of the interval.
This function is used per default for MATCH mode.
The `BELL` function is a Gaussian bell curve, specified through the boundary values of
the sigma
interval, reaching the maximum value of 1 at the interval center.
